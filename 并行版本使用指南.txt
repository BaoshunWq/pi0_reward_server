================================================================================
                    Pi0 Reward Server å¹¶è¡Œç‰ˆæœ¬ä½¿ç”¨æŒ‡å—
================================================================================

âœ… æ”¹é€ å®Œæˆï¼ç°åœ¨ä½ çš„Reward Serveræ”¯æŒï¼š
   - å¤šGPUå¹¶è¡Œå¤„ç†è¯·æ±‚
   - åœ¨ä¸¤å¼ æ˜¾å¡ä¸ŠåŒæ—¶è¿è¡ŒPi0æ¨¡å‹
   - è·¨ç½‘ç»œè®¿é—®ï¼ˆAutoDLå¹³å°ï¼‰
   - ç”Ÿäº§çº§éƒ¨ç½²ï¼ˆGunicornï¼‰

================================================================================
                              å¿«é€Ÿå¼€å§‹
================================================================================

ç¬¬1æ­¥ï¼šå¯åŠ¨Pi0æ¨¡å‹æœåŠ¡ï¼ˆä¸¤å¼ GPUï¼‰
---------------------------------

æ–¹æ³•A - è‡ªåŠ¨å¯åŠ¨ï¼ˆæ¨èï¼‰ï¼š
   cd /root/code/saftyVLA/pi0_reward_server
   ./start_pi0_models.sh

æ–¹æ³•B - æ‰‹åŠ¨å¯åŠ¨ï¼š
   # ç»ˆç«¯1 - GPU 0
   CUDA_VISIBLE_DEVICES=0 python ä½ çš„pi0æœåŠ¡è„šæœ¬ --port 8000 &
   
   # ç»ˆç«¯2 - GPU 1
   CUDA_VISIBLE_DEVICES=1 python ä½ çš„pi0æœåŠ¡è„šæœ¬ --port 8001 &

ç¬¬2æ­¥ï¼šå¯åŠ¨Reward Server
-----------------------

   cd /root/code/saftyVLA/pi0_reward_server
   export GPU_PORTS="8000,8001"
   export PORT=6006
   ./start_server.sh

   é€‰æ‹©æ¨¡å¼ï¼š
   - è¾“å…¥ 1 = å¼€å‘æ¨¡å¼ï¼ˆFlaskå†…ç½®æœåŠ¡å™¨ï¼‰
   - è¾“å…¥ 2 = ç”Ÿäº§æ¨¡å¼ï¼ˆGunicornï¼Œæ¨èï¼‰

ç¬¬3æ­¥ï¼šæµ‹è¯•æœåŠ¡
-------------

   # å¥åº·æ£€æŸ¥
   curl http://localhost:6006/health
   
   # æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€
   curl http://localhost:6006/pool_status
   
   # è¿è¡Œå®Œæ•´æµ‹è¯•
   python example_client.py

================================================================================
                        AutoDLå¹³å°è·¨ç½‘ç»œè®¿é—®é…ç½®
================================================================================

ä½ çš„é—®é¢˜æ˜¯ï¼šç›®å‰åªèƒ½åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šè®¿é—®ï¼Œå¦‚ä½•è®©å…¶ä»–ç½‘ç»œçš„æœåŠ¡å™¨è®¿é—®ï¼Ÿ

è§£å†³æ–¹æ¡ˆï¼š
---------

1. åœ¨AutoDLæ§åˆ¶å°é…ç½®ç«¯å£æ˜ å°„
   - ç™»å½•AutoDLæ§åˆ¶å°
   - è¿›å…¥ä½ çš„å®ä¾‹è¯¦æƒ…é¡µé¢
   - æ‰¾åˆ°"è‡ªå®šä¹‰æœåŠ¡"æˆ–"ç«¯å£æ˜ å°„"åŠŸèƒ½
   - æ·»åŠ ç«¯å£æ˜ å°„ï¼šå†…éƒ¨ç«¯å£ 6006 -> å…¬ç½‘ç«¯å£ï¼ˆAutoDLä¼šåˆ†é…ï¼‰
   
2. è·å–å…¬ç½‘è®¿é—®åœ°å€
   - AutoDLä¼šæä¾›ç±»ä¼¼è¿™æ ·çš„åœ°å€ï¼š
     http://region-xxx.seetacloud.com:12345
   
3. å…¶ä»–æœåŠ¡å™¨è®¿é—®
   åœ¨å…¶ä»–æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š
   
   import requests
   
   url = "http://region-xxx.seetacloud.com:12345/score"
   response = requests.post(url, json={
       "responses": ["instruction 1", "instruction 2"],
       "reward_function_kwargs": {
           "max_workers": 2,  # ä½¿ç”¨2ä¸ªGPUå¹¶è¡Œ
           "num_trials_per_task": 5
       }
   })
   
   print(response.json())

é‡è¦æç¤ºï¼š
---------
- Pi0æ¨¡å‹æœåŠ¡ï¼ˆ8000, 8001ï¼‰åªéœ€è¦å†…ç½‘è®¿é—®ï¼Œä¸ç”¨æš´éœ²åˆ°å…¬ç½‘
- åªéœ€è¦å°†Reward Serverçš„ç«¯å£ï¼ˆ6006ï¼‰æ˜ å°„åˆ°å…¬ç½‘å³å¯
- ç¡®ä¿6006æ˜¯AutoDLæ”¯æŒçš„ç«¯å£ï¼ˆé€šå¸¸6006ã€8080ã€8888ç­‰éƒ½æ”¯æŒï¼‰

================================================================================
                              æ–‡ä»¶æ¸…å•
================================================================================

âœ… æ ¸å¿ƒä»£ç ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰
   pi0_reward_server/client_pool.py              - è¿æ¥æ± ç®¡ç†å™¨
   pi0_reward_server/env_pertask_parallel.py     - å¹¶è¡Œä»»åŠ¡è¯„ä¼°
   pi0_reward_server/reward_core_parallel.py     - å¹¶è¡Œè¯„åˆ†æ ¸å¿ƒ
   pi0_reward_server/app_pi0_libero_parallel.py  - å¹¶è¡ŒFlaskåº”ç”¨
   pi0_reward_server/config.py                   - é…ç½®ç®¡ç†

âœ… é…ç½®æ–‡ä»¶ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰
   gunicorn_config.py                             - Gunicorné…ç½®
   requirements_parallel.txt                      - ä¾èµ–åˆ—è¡¨

âœ… è„šæœ¬æ–‡ä»¶ï¼ˆ5ä¸ªæ–‡ä»¶ï¼‰
   start_server.sh                                - å¯åŠ¨Reward Server
   start_pi0_models.sh                            - å¯åŠ¨Pi0æ¨¡å‹æœåŠ¡
   stop_pi0_models.sh                             - åœæ­¢Pi0æ¨¡å‹æœåŠ¡
   example_client.py                              - æµ‹è¯•å®¢æˆ·ç«¯
   test_setup.sh                                  - ç¯å¢ƒæ£€æŸ¥

âœ… æ–‡æ¡£æ–‡ä»¶ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰
   README_PARALLEL.md                             - è¯¦ç»†æ–‡æ¡£
   QUICKSTART.md                                  - å¿«é€Ÿå¼€å§‹
   CHANGES_SUMMARY.md                             - æ”¹é€ æ€»ç»“
   å¹¶è¡Œç‰ˆæœ¬ä½¿ç”¨æŒ‡å—.txt                           - æœ¬æ–‡æ¡£

================================================================================
                            æ€§èƒ½å¯¹æ¯”
================================================================================

åœºæ™¯1ï¼šå•ä¸ªä»»åŠ¡
   åŸç‰ˆï¼š100ç§’
   å¹¶è¡Œç‰ˆï¼š100ç§’ï¼ˆæ— å·®å¼‚ï¼‰

åœºæ™¯2ï¼š2ä¸ªä»»åŠ¡
   åŸç‰ˆï¼š200ç§’ï¼ˆä¸²è¡Œï¼‰
   å¹¶è¡Œç‰ˆï¼š~100ç§’ï¼ˆå¹¶è¡Œï¼‰âš¡ å¿«2å€

åœºæ™¯3ï¼š10ä¸ªä»»åŠ¡
   åŸç‰ˆï¼š1000ç§’ï¼ˆä¸²è¡Œï¼‰
   å¹¶è¡Œç‰ˆï¼š~500ç§’ï¼ˆ2ä¸ªGPUè½®æµï¼‰âš¡ å¿«2å€

================================================================================
                          å¸¸ç”¨å‘½ä»¤å‚è€ƒ
================================================================================

# ç¯å¢ƒæ£€æŸ¥
./test_setup.sh

# å¯åŠ¨æœåŠ¡
./start_pi0_models.sh      # å¯åŠ¨GPUæœåŠ¡
./start_server.sh          # å¯åŠ¨Reward Server

# åœæ­¢æœåŠ¡
./stop_pi0_models.sh       # åœæ­¢GPUæœåŠ¡
pkill -f gunicorn          # åœæ­¢Reward Server

# æµ‹è¯•
curl http://localhost:6006/health
curl http://localhost:6006/pool_status
python example_client.py

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/pi0_gpu0.log  # GPU 0æ—¥å¿—
tail -f logs/pi0_gpu1.log  # GPU 1æ—¥å¿—

# ç›‘æ§GPU
watch -n 1 nvidia-smi

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep python

# æŸ¥çœ‹ç«¯å£
netstat -tlnp | grep -E '6006|8000|8001'

================================================================================
                          æ•…éšœæ’æŸ¥
================================================================================

é—®é¢˜1ï¼šè¿æ¥æ± åˆå§‹åŒ–å¤±è´¥
é”™è¯¯ï¼šClient pool not initialized

è§£å†³ï¼š
   1. æ£€æŸ¥Pi0æ¨¡å‹æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼š
      curl http://localhost:8000/health
      curl http://localhost:8001/health
   
   2. å¦‚æœæ²¡å¯åŠ¨ï¼Œè¿è¡Œï¼š
      ./start_pi0_models.sh

é—®é¢˜2ï¼šç«¯å£è¢«å ç”¨
é”™è¯¯ï¼šAddress already in use

è§£å†³ï¼š
   # æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
   netstat -tlnp | grep 6006
   
   # æ€æ­»è¿›ç¨‹
   kill -9 è¿›ç¨‹ID
   
   # æˆ–æ›´æ”¹ç«¯å£
   export PORT=6007

é—®é¢˜3ï¼šGPUå†…å­˜ä¸è¶³
é”™è¯¯ï¼šCUDA out of memory

è§£å†³ï¼š
   1. å‡å°‘å¹¶è¡Œworkeræ•°é‡
   2. å‡å°‘num_trials_per_task
   3. é‡å¯GPUæœåŠ¡é‡Šæ”¾æ˜¾å­˜

é—®é¢˜4ï¼šæ— æ³•ä»å…¶ä»–æœåŠ¡å™¨è®¿é—®
é”™è¯¯ï¼šConnection refused

è§£å†³ï¼š
   1. ç¡®è®¤å·²åœ¨AutoDLé…ç½®ç«¯å£æ˜ å°„
   2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   3. ä½¿ç”¨å…¬ç½‘åœ°å€è€Œä¸æ˜¯localhost
   4. ç¡®è®¤ç«¯å£æ˜¯AutoDLæ”¯æŒçš„ç«¯å£

================================================================================
                          é…ç½®ç¯å¢ƒå˜é‡
================================================================================

å¯é€‰ï¼šåˆ›å»º .env æ–‡ä»¶ï¼ˆå·²æä¾› .env.example æ¨¡æ¿ï¼‰

å¸¸ç”¨ç¯å¢ƒå˜é‡ï¼š
   export PORT=6006                    # Reward Serverç«¯å£
   export GPU_PORTS="8000,8001"        # GPUç«¯å£åˆ—è¡¨
   export GPU_HOST="0.0.0.0"           # GPUä¸»æœºåœ°å€
   export GUNICORN_WORKERS=2           # Workeræ•°é‡
   export GUNICORN_TIMEOUT=1800        # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
   export LOG_LEVEL=info               # æ—¥å¿—çº§åˆ«

================================================================================
                          APIä½¿ç”¨ç¤ºä¾‹
================================================================================

å•ä¸ªä»»åŠ¡ï¼ˆå…¼å®¹åŸç‰ˆï¼‰ï¼š
   POST http://localhost:6006/score
   {
     "responses": ["pick up the bowl"],
     "reward_function_kwargs": {
       "num_trials_per_task": 5
     }
   }

å¤šä¸ªä»»åŠ¡å¹¶è¡Œå¤„ç†ï¼ˆæ–°åŠŸèƒ½ï¼‰ï¼š
   POST http://localhost:6006/score
   {
     "responses": ["task1", "task2", "task3", "task4"],
     "reward_function_kwargs": {
       "max_workers": 2,           # ä½¿ç”¨2ä¸ªGPUå¹¶è¡Œ
       "num_trials_per_task": 5
     }
   }

æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€ï¼š
   GET http://localhost:6006/pool_status
   
   è¿”å›ï¼š
   {
     "total_clients": 2,
     "available_clients": 2,
     "hosts_ports": [...]
   }

================================================================================
                          è¯¦ç»†æ–‡æ¡£
================================================================================

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š
   - QUICKSTART.md         - 30ç§’å¿«é€Ÿå¼€å§‹
   - README_PARALLEL.md    - å®Œæ•´åŠŸèƒ½æ–‡æ¡£
   - CHANGES_SUMMARY.md    - æŠ€æœ¯æ”¹é€ ç»†èŠ‚

================================================================================
                          æ”¯æŒä¸å¸®åŠ©
================================================================================

å¦‚é‡åˆ°é—®é¢˜ï¼š
   1. è¿è¡Œç¯å¢ƒæ£€æŸ¥ï¼š./test_setup.sh
   2. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼šlogs/*.log
   3. æ£€æŸ¥GPUçŠ¶æ€ï¼šnvidia-smi
   4. å‚è€ƒæ•…éšœæ’æŸ¥ç« èŠ‚

================================================================================
                    ç°åœ¨å¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼ğŸš€
================================================================================

ç¥ä½¿ç”¨æ„‰å¿«ï¼ä½ çš„Reward Serverç°åœ¨å¯ä»¥é«˜æ•ˆåœ°å¹¶è¡Œå¤„ç†è¯·æ±‚äº†ã€‚

